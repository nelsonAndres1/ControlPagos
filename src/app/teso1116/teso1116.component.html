<h4>Administrar Permisos</h4>

<!-- Datos del usuario -->
<div class="card card-body mb-3">
    <h6>Usuario: {{ itemDetail?.usuario }}</h6>
    <h6>Nombre: {{ itemDetail?.nombre }}</h6>
    <h6>Cédula: {{ itemDetail?.cedtra }}</h6>
</div>

<!-- Agregar permisos -->
<form (submit)="$event.preventDefault(); submitAgregar();">
    <div class="card card-body mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Agregar permisos</h5>
            <small class="text-muted">Seleccionados: {{ selectedList.length }}</small>
        </div>

        <table class="table table-striped table-bordered table-hover mt-2">
            <thead>
                <tr>
                    <th>Permiso</th>
                    <th>Agregar</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let dt of estados; trackBy: trackByNombre">
                    <td>{{ dt }}</td>
                    <td>
                        <input type="checkbox" [checked]="isChecked(dt)" (change)="onChangeAgregar($event, dt)" />
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="d-flex justify-content-end mt-2">
            <button type="submit" class="btn btn-success" [disabled]="isSubmitting">
                {{ isSubmitting ? 'Guardando...' : 'Agregar seleccionados' }}
            </button>
        </div>
    </div>
</form>

<!-- Permisos actuales -->
<div class="card card-body mb-1">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Permisos actuales</h5>
        <small class="text-muted">Total: {{ existingList.length }}</small>
    </div>

    <ng-container *ngIf="existingList.length > 0; else noPerms">
        <table class="table table-striped table-bordered table-hover mt-2">
            <thead>
                <tr>
                    <th>Permiso</th>
                    <th>Código</th>
                    <th>Seleccionar</th>
                    <th style="width: 1%;">Acción</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let code of existingList; trackBy: trackByCode">
                    <td>{{ codeToNombre[code] || code }}</td>
                    <td><code>{{ code }}</code></td>
                    <td class="text-center">
                        <input type="checkbox" [checked]="removeCodes.has(code)"
                            (change)="toggleRemoveEvent($event, code)" />
                    </td>
                    <td class="text-nowrap">
                        <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeOne(code)">
                            Quitar
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-muted">Marcados para eliminar: {{ removeList.length }}</small>
            <button type="button" class="btn btn-danger" (click)="removeSelectedBulk()">
                Eliminar seleccionados
            </button>
        </div>
    </ng-container>

    <ng-template #noPerms>
        <div class="alert alert-info mt-2 mb-0">
            Este usuario no tiene permisos asignados.
        </div>
    </ng-template>
</div>

<!-- Reporte de permisos -->
<div class="card card-body mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Reporte de permisos (todas las personas)</h5>
        <div>
            <button class="btn btn-outline-primary me-2" (click)="cargarReporte()" [disabled]="cargandoReporte">
                {{ cargandoReporte ? 'Cargando...' : 'Cargar reporte' }}
            </button>
            <!-- <button class="btn btn-outline-success" (click)="exportarCSV()">
                Exportar CSV
            </button> -->
        </div>
    </div>

    <div class="table-responsive mt-3" *ngIf="reporte.length > 0; else sinDatos">
        <table class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Nombre</th>
                    <th>Cédula</th>
                    <th>Código</th>
                    <th>Permiso</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let r of reporte; trackBy: trackByReporte">
                    <td>{{ r.usuario }}</td>
                    <td>{{ r.nombre }}</td>
                    <td>{{ r.cedtra }}</td>
                    <td><code>{{ r.estche }}</code></td>
                    <td>{{ r.permiso }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <ng-template #sinDatos>
        <div class="alert alert-info mt-3 mb-0">Aún no hay datos de reporte. Haz clic en “Cargar reporte”.</div>
    </ng-template>
</div>